function changeFullScreen(e){fullScreen.src=e,currentFullScreenSrc=e,fullScreen.setAttribute("autoplay","true"),e===item.getElementsByClassName("video")[0].src&&(fullscreen.muted=!0)}function addTouchListener(e){e.addEventListener("touchend",function(){list.getElementsByClassName("video-item-current")[0].getElementsByClassName("video")[0].setAttribute("autoplay","true"),removeClass(list.getElementsByClassName("video-item-current")[0],"video-item-current"),addClass(this,"video-item-current"),e.getElementsByClassName("video")[0].setAttribute("autoplay","false"),isPc||changeFullScreen(e.getElementsByClassName("video")[0].src)})}function mute(){removeClass(document.querySelector(".mute"),"mute-hide")}function voice(){addClass(document.querySelector(".mute"),"mute-hide")}function muteAll(){Array.prototype.slice.call(list.children,0).forEach(function(e,t){e.getElementsByClassName("video")[0].muted=!0})}function unmuteAll(){Array.prototype.slice.call(list.children,0).forEach(function(e,t){0!==t&&(e.getElementsByClassName("video")[0].muted=!1)})}function itemBindHover(e){e.addEventListener("mouseenter",function(){addClass(this.querySelector(".video-ctrl"),"video-ctrl-show")}),e.addEventListener("mouseleave",function(){removeClass(this.querySelector(".video-ctrl"),"video-ctrl-show")}),e.querySelector(".camera-on").addEventListener("click",function(){removeClass(this,"ctrl-show"),addClass(e.querySelector(".camera-off"),"ctrl-show"),localStream.enableVideo(!1),list.children[0].querySelector(".video").style.display="none";var t=auth.currentUser.uid;ref.child("isVideo/"+t).set(!1),ref.child("isVideo/"+t).onDisconnect().remove()}),e.querySelector(".camera-off").addEventListener("click",function(){removeClass(this,"ctrl-show"),addClass(e.querySelector(".camera-on"),"ctrl-show"),localStream.enableVideo(!0),list.children[0].querySelector(".video").style.display="inline-block";var t=auth.currentUser.uid;ref.child("isVideo/"+t).set(!0),ref.child("isVideo/"+t).onDisconnect().remove()}),e.querySelector(".voice-on").addEventListener("click",function(){removeClass(this,"ctrl-show"),addClass(e.querySelector(".voice-off"),"ctrl-show"),localStream.enableAudio(!1)}),e.querySelector(".voice-off").addEventListener("click",function(){removeClass(this,"ctrl-show"),addClass(e.querySelector(".voice-on"),"ctrl-show"),localStream.enableAudio(!0)})}function arrShow(){var e=listContent.scrollLeft,t=Number(getComputedStyle(listContent).width.replace("px",""));0===e?(arrLeft.style.display="none",shadowLeft.style.display="none"):(arrLeft.style.display="block",shadowLeft.style.display="block",e===listCurrentWidth-t?(arrRight.style.display="none",shadowRight.style.display="none"):(arrRight.style.display="block",shadowRight.style.display="block"))}var arr=window.location.href.split("="),roomId=decodeURI(arr[arr.length-1]),rtc,currentFullScreenSrc,localAudioTracks=[],localVideoTracks=[],remoteList=[],header=document.getElementsByClassName("header")[0],listContent=document.getElementsByClassName("video-list-content")[0],fullScreen=document.getElementsByClassName("video-full")[0],arrows=document.getElementsByClassName("arr"),arrLeft=arrows[0],arrRight=arrows[1],shadows=document.getElementsByClassName("shadow"),shadowLeft=shadows[0],shadowRight=shadows[1],meetingUrl=document.getElementById("meeting-url");meetingUrl&&(meetingUrl.value=window.location.href);var addClass=function(e,t){e.className.indexOf(t)===-1&&(e.className+=" "+t)},removeClass=function(e,t){var o,i=e.className;1!==i.indexOf(t)&&(o=" "+t),e.className=i.replace(o,"")},toggleClass=function(e,t){var o=e.className.indexOf(t)===-1;o?addClass(e,t):removeClass(e,t)},isPc=function(){for(var e=navigator.userAgent,t=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"),o=!0,i=0;i<t.length;i++)if(e.indexOf(t[i])>0){o=!1;break}return o}(),item=document.querySelector(".video-item"),list=document.querySelector(".video-list"),itemWidth=Number(getComputedStyle(item).width.replace("px","")),count,listCurrentWidth=Number(getComputedStyle(list).width.replace("px",""));item.getElementsByClassName("video")[0].muted=!0;var insertItem=function(e){var t=item.cloneNode(!0);if(e.attach(t.querySelector(".video")),t.querySelector(".video").setAttribute("id",""),t.querySelector(".video").setAttribute("width","100%"),t.querySelector(".video").setAttribute("height","100%"),t.querySelector(".video").muted=!1,removeClass(t,"video-item-current"),list.children.length>2&&!isPc&&(listCurrentWidth=20+list.children.length*itemWidth,list.style.width=listCurrentWidth+"px"),list.appendChild(t),count=remoteList.length,isPc?(t.querySelector(".camera-tips").textContent="对方未开启摄像头",t.querySelector(".video-content").removeChild(t.querySelector(".video-ctrl")),2===count?addClass(list,"video-list-double"):3===count&&addClass(list,"video-list-multiple")):addTouchListener(t),!isPc){arrShow();var o=getComputedStyle(t).height;document.getElementsByClassName("shadow-img")[0].style.height=o,document.getElementsByClassName("shadow-img")[1].style.height=o}};isPc||addTouchListener(item);var removeItem=function(e){e<0||(list.removeChild(list.children[e]),count=remoteList.length,2===count?removeClass(list,"video-list-multiple"):1===count&&(removeClass(list,"video-list-double"),isPc||changeFullScreen(item.getElementsByClassName("video")[0].src),addClass(item,"video-item-current")),isPc||(listCurrentWidth=20+(list.children.length-1)*itemWidth,list.style.width=listCurrentWidth+"px",arrShow()))};if(document.getElementsByClassName("copy-btn")[0]){var clipboard=new Clipboard(".copy-btn");clipboard.on("success",function(e){e.trigger.textContent="复制成功"}),clipboard.on("error",function(e){e.trigger.textContent="已经选中"})}if(isPc)itemBindHover(item),addClass(item.querySelector(".voice-on"),"ctrl-show"),addClass(item.querySelector(".camera-on"),"ctrl-show");else{var mute=!1,cameraOff=!1,voiceOff=!1;document.getElementsByClassName("video-ctrl-m")[0].addEventListener("touchend",function(e){e.stopPropagation(),toggleClass(this.children[0],"ctrl-content-hide"),toggleClass(document.getElementsByClassName("video-list-content")[0],"video-list-content-down"),toggleClass(header,"header-hide"),toggleClass(arrLeft,"arr-down"),toggleClass(arrRight,"arr-down"),toggleClass(shadowLeft,"shadow-down"),toggleClass(shadowRight,"shadow-down")}),Array.prototype.slice.call(document.getElementsByClassName("ctrls")[0].children,0).forEach(function(e,t){e.children[0].addEventListener("touchend",function(e){if(e.stopPropagation(),toggleClass(this,"ctrl-on"),0===t)mute=!mute,0==mute?localStream.enableAudio(!0):localStream.enableAudio(!1);else if(1===t)if(cameraOff=!cameraOff,0==cameraOff){localStream.enableVideo(!0);var o=auth.currentUser.uid;ref.child("isVideo/"+o).set(!0),ref.child("isVideo/"+o).onDisconnect().remove()}else{localStream.enableVideo(!1);var o=auth.currentUser.uid;ref.child("isVideo/"+o).set(!1)}else 2===t&&(voiceOff=!voiceOff,0==voiceOff?unmuteAll():muteAll())})}),document.getElementById("roomid").textContent=roomId,document.getElementsByClassName("video-list-content")[0].addEventListener("scroll",arrShow),document.addEventListener("touchend",function(){addClass(header,"header-hide"),addClass(document.getElementsByClassName("ctrl-content")[0],"ctrl-content-hide"),addClass(document.getElementsByClassName("video-list-content")[0],"video-list-content-down"),addClass(shadowLeft,"shadow-down"),addClass(shadowRight,"shadow-down"),addClass(arrLeft,"arr-down"),addClass(arrRight,"arr-down")})}var constraints;constraints=isPc?{audio:!0,video:{frameRate:15,width:320,height:180}}:{audio:!0,video:{frameRate:15,width:320,height:240}};var config={authDomain:"wildrtc.wilddog.com",syncURL:"https://wildrtc.wilddogio.com"};wilddog.initializeApp(config);var ref=wilddog.sync(),auth=wilddog.auth(),videoInstance=wilddog.video();wilddog.auth().signInAnonymously().then(function(e){remoteList.push(e.uid);var t=videoInstance.client();videoInstance.createStream({audio:!0,video:"low"}).then(function(o){if(localStream=o,localStream.attach("#localStream"),/macintosh|mac os x/i.test(navigator.userAgent)&&(document.getElementById("localStream").style.width="100%",document.getElementById("localStream").style.height="100%"),item.getElementsByClassName("video")[0].muted=!0,!isPc){var i=document.getElementById("fullscreen");wildStream.bindToDOM(i)}ref.child("isVideo/"+e.uid).set(!0),ref.child("isVideo/"+e.uid).onDisconnect().remove();var l=t.connectToConference(roomId,{stream:localStream,userData:"wildrtc"});l.on("participant_connected",function(e){e.on("streamAdded",function(t){remoteList.push(e.Id),insertItem(t),ref.child("isVideo/"+e.Id).on("value",function(t){var o=remoteList.indexOf(e.Id);t.val()===!1?list.children[o].querySelector(".video").style.display="none":t.val()===!0&&(list.children[o].querySelector(".video").style.display="inline-block")})})}),l.on("participant_disconnected",function(e){var t=e.Id,o=remoteList.indexOf(t);o>=0&&(remoteList.splice(o,1),removeItem(o)),ref.child("isVideo/"+t).off("value"),ref.child("isVideo/"+t).set(null)})})["catch"](function(e){console.error(e)})});var exit=document.querySelector(".exit");exit.onclick=function(){window.location.href="/"};